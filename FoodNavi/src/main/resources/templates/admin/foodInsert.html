<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:insert="~{/admin/include/headerAdmin}"></th:block>

<meta charset="UTF-8">

<title>User Info</title>

<h1><a href="admin_main"><img src="/assets/images/foodNaviFont.png" alt="foodNaviFont" class="foodNaviFont"></a></h1>

<article id="box">
    <h2>Food Insert</h2>
    <form method="post" action="admin_food_insert" enctype="multipart/form-data">
        <table>
            <tr>
                <th><label for="img">이미지 첨부 :</label></th>
                <td><input type="file" id="img" name="img" accept="food_images/*"></td>
            </tr>
            <tr>
                <th>이름</th>
                <td><input type="text" name="name"/></td>
            </tr>
            <tr>
                <th>칼로리(kcal)</th>
                <td>
                    <span type="number" name="span_kcal" id="span_kcal"/>
                    <input type="hidden" name="kcal" id="kcal"/>
                </td>

            </tr>
            <tr>
                <th>탄수화물(g)</th>
                <td>
                    <span type="number" name="span_carb" id="span_carb"/>
                    <input type="hidden" name="carb" id="carb"/>
                </td>
            </tr>
            <tr>
                <th>단백질(g)</th>
                <td>
                    <span type="number" name="span_prt" id="span_prt"/>
                    <input type="hidden" name="prt" id="prt"/>
                </td>
            </tr>
            <tr>
                <th>지방(g)</th>
                <td>
                    <span type="number" name="span_fat" id="span_fat"/>
                    <input type="hidden" name="fat" id="fat"/>
                </td>
            </tr>
        </table>

        <h2>재료</h2>
        <table id="mytable">
            <thead>
            <tr>
                <th>재료</th>
                <th>수량</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <input type="button" class="button" id='btn-add-row' value="행 추가">

            </tbody>
        </table>

        <script src="//code.jquery.com/jquery.min.js"></script>
        <script>

            $(document).ready(function() {
                $('#btn-add-row').trigger('click');
            });

            $(document).on('keydown', function (event) {
                if (event.key == "Enter" && document.activeElement.name === "quantity") {
                    event.preventDefault();
                    $('#mytable > tbody:last').append('<tr><td><input type="text" name="ingredient"></td>' +
                        '<td><input type="number" name="quantity" min="0">g</td>' +
                        '<td><input type="button" name="cal" value="게산" onclick="ingredientCal(this)"></td>' +
                        '<td><input type="button" class="button" id="btn-delete-row" value="삭제"></td></tr>');
                    initAutocomplete();
                    $('input[name="ingredient"]').focus();
                } else if (event.key == "Enter") {
                    $('input[name="quantity"]').focus();
                }
            });

            $('#btn-add-row').click(function () {
                var time = new Date().toLocaleTimeString();
                event.preventDefault();
                $('#mytable > tbody:last').append('<tr><td><input type="text" name="ingredient"></td>' +
                    '<td><input type="number" name="quantity" min="0">g</td>' +
                    '<td><input type="button" name="cal" value="게산" onclick="ingredientCal(this)"></td>' +
                    '<td><input type="button" class="button" id="btn-delete-row" value="삭제"></td></tr>');
                initAutocomplete();
            });


            $('#mytable').on('click', '#btn-delete-row', function () {
                event.preventDefault();
                $(this).closest('tr').remove();
            });
        </script>
        <!-- 영양성분 합산 테스트용 코드 -->
        <script th:inline="javascript">
            function ingredientCal() {
                var calData = [];
                $("#mytable tr").each(function() {
                    var name = $(this).find("input[name='ingredient']").val();
                    var amount = $(this).find("input[name='quantity']").val();

                    calData.push({
                        name: name,
                        amount: amount
                    });
                });


                $.ajax({
                    method: 'POST',
                    url: '/admin_igrd_cal',
                    data: JSON.stringify(calData),
                    contentType: 'application/json',
                    success: function (response) {
                        alert('전송성공');
                        console.log(response);
                        $("#span_kcal").text(response.kcal);
                        $("#kcal").val(response.kcal);
                        $("#span_carb").text(response.carb);
                        $("#carb").val(response.carb);
                        $("#span_prt").text(response.prt);
                        $("#prt").val(response.prt);
                        $("#span_fat").text(response.fat);
                        $("#fat").val(response.fat);

                        $("form").append('<input type="hidden" name="kcal" value="' + response.kcal + '">');
                        $("form").append('<input type="hidden" name="carb" value="' + response.carb + '">');
                        $("form").append('<input type="hidden" name="prt" value="' + response.prt + '">');
                        $("form").append('<input type="hidden" name="fat" value="' + response.fat + '">');
                    },
                    error: function (error) {
                        alert('전송실패');
                    }
                });
            }
        </script>
        <!-- 영양성분 합산 테스트용 코드 -->
        <div class="field">
            <label for="foodType">식단 종류</label>
            <select name="foodType" id="foodType">
                <option value="주식">주식</option>
                <option value="부식">부식</option>
                <option value="간식">부식</option>
            </select>
        </div>


        <div class="adminButton">
            <input type="submit" class="button" value="등록하기">
            <input type="reset" class="button" value="다시하기">
        </div>
    </form>
    <a href="admin_food_list">
        <button>등록취소</button>
    </a>
</article>
<th:block th:insert="~{/includes/footer}"></th:block>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/assets/js/autocomplete.js"></script>